ğŸ”§ Codex ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆã‚³ãƒ”ãƒšã§OKï¼‰

Goal:
æ—¢å­˜ã® subtitle-api ãƒªãƒã‚’ Vercel Serverless ã§å‹•ãAPIã«ãƒªãƒ©ã‚¤ãƒˆã€‚/api/transcribe ã®1æœ¬åŒ–ã€OpenAI gpt-4o-transcribe ã«ç›´æ¸¡ã—ã€SRT/VTT/Textã‚’JSONã§è¿”ã™ã€‚ffmpeg/å¸¸é§ã‚µãƒ¼ãƒã¯æ’¤å»ã€‚GPTs Actions ã‹ã‚‰å©ã‘ã‚‹ã‚ˆã† OpenAPI ã‚‚åŒæ¢±ã€‚

Hard requirements:

api/transcribe.ts ã‚’æ–°è¨­ï¼ˆExpressä¸è¦ãƒ»export default handlerï¼‰ã€‚

SUBTITLE_API_KEYï¼ˆãƒ˜ãƒƒãƒ€ X-API-Keyï¼‰ã§èªè¨¼ã€‚

å…¥åŠ›: file_url(å¿…é ˆ), output_format(srt|vtt|text=æ—¢å®š srt), language(ä»»æ„)

å‡ºåŠ›: JSON ã« srt or vtt or text ã‚’ç›´æ¥æ ¼ç´ï¼ˆURLä¿å­˜ã¯ã—ãªã„ï¼‰ã€‚

ffmpeg ã‚’ä½¿ã‚ãªã„ã€‚

vercel.json ã§ Node 20 / duration / memory ã‚’æŒ‡å®šã€‚

package.json ã®ä¾å­˜ã¯ openai ã®ã¿ã§ååˆ†ï¼ˆTypeScript ã¯VercelãŒè‡ªå‹•ã§å‡¦ç†ï¼‰ã€‚

OpenAPIï¼ˆGPTsç”¨ï¼‰ã¯ /api/transcribe & file_url ä»•æ§˜ã€‚

æ—¢å­˜ã® src/index.ts ã‚„ ffmpeg é–¢é€£ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã¯ä½¿ã‚ãªã„ï¼ˆæ®‹ã£ã¦ã‚‚OKã ãŒä»¥å¾Œæœªä½¿ç”¨ï¼‰ã€‚

Do: ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ/ä¸Šæ›¸ãã—ã¦ã‚³ãƒŸãƒƒãƒˆã€‚å·®åˆ†ã¯ä¸è¦ã€‚ä¸­èº«ã¯å®Œå…¨ã«ã“ã®é€šã‚Šã§ä½œã£ã¦ã€‚

api/transcribe.ts
import type { VercelRequest, VercelResponse } from '@vercel/node';
import { OpenAI } from 'openai';

function textToSrt(text: string) {
  const lines = text.split(/\r?\n/).filter(Boolean);
  return lines.map((line, i) => {
    const start = `00:00:${String(i).padStart(2,'0')},000`;
    const end   = `00:00:${String(i+1).padStart(2,'0')},000`;
    return `${i+1}\n${start} --> ${end}\n${line}\n`;
  }).join('\n');
}

export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method Not Allowed' });

  // Auth
  const expected = process.env.SUBTITLE_API_KEY;
  if (!expected) return res.status(500).json({ error: 'Server not configured' });
  if ((req.headers['x-api-key'] as string) !== expected) return res.status(401).json({ error: 'Unauthorized' });

  try {
    const { file_url, output_format = 'srt', language } = (req.body ?? {}) as {
      file_url?: string; output_format?: 'srt'|'vtt'|'text'; language?: string;
    };
    if (!file_url) return res.status(422).json({ error: 'file_url is required' });

    // fetch file bytes
    const r = await fetch(file_url);
    if (!r.ok) throw new Error(`fetch file_url failed: ${r.status}`);
    const buf = Buffer.from(await r.arrayBuffer());

    // OpenAI transcribe (no ffmpeg)
    const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
    const tx = await client.audio.transcriptions.create({
      model: 'gpt-4o-transcribe',
      file: new File([buf], 'input.mp4', { type: 'audio/mp4' }),
      // language, // enable when the API supports explicit hint reliably
      response_format: 'verbose_json'
    });

    const text = tx.text || '';
    const preview = text.slice(0, 2000);

    if (output_format === 'text') {
      return res.status(200).json({ format: 'text', text, text_preview: preview });
    }
    if (output_format === 'vtt') {
      const vtt = 'WEBVTT\n\n' + textToSrt(text).replace(/,000/g, '.000');
      return res.status(200).json({ format: 'vtt', vtt, text_preview: preview });
    }
    const srt = textToSrt(text);
    return res.status(200).json({ format: 'srt', srt, text_preview: preview });
  } catch (e: any) {
    console.error(e);
    return res.status(500).json({ error: String(e?.message || e) });
  }
}

vercel.json
{
  "functions": {
    "api/**": {
      "runtime": "nodejs20.x",
      "maxDuration": 60,
      "memory": 1024
    }
  }
}

package.json
{
  "name": "subtitle-api",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "engines": { "node": ">=20" },
  "dependencies": {
    "openai": "^4.58.0"
  }
}

openapi.yaml
openapi: 3.1.0
info:
  title: Subtitle API
  version: "1.0.0"
  description: API that generates SRT/VTT/Text from an uploaded file URL for GPTs Custom Actions.
servers:
  - url: https://<your-vercel-project>.vercel.app
paths:
  /api/transcribe:
    post:
      operationId: transcribeVideo
      summary: Transcribe a video/audio file from a temporary URL and return subtitles
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [file_url]
              properties:
                file_url:
                  type: string
                  format: uri
                  description: Signed URL to the uploaded media file
                output_format:
                  type: string
                  enum: [srt, vtt, text]
                  default: srt
                language:
                  type: string
                  description: BCP-47 language code (e.g. "ja")
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  format: { type: string, enum: [srt, vtt, text] }
                  text_preview: { type: string }
                  srt: { type: string }
                  vtt: { type: string }
                  text: { type: string }
        "401": { description: Unauthorized }
        "422": { description: Bad Request }
        "500": { description: Internal Server Error }
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
  schemas: {}

.gitignore
node_modules
.vercel
.env
.DS_Store

README.mdï¼ˆæŠœç²‹ãƒ»æœ€å°ï¼‰
# subtitle-api (Vercel Serverless)

## Env
- OPENAI_API_KEY: your OpenAI key
- SUBTITLE_API_KEY: any long random secret (must match GPTs Action header `X-API-Key`)

## Deploy
- Vercel Project: Framework=Other / Build/Output/Install: empty
- `vercel.json` sets Node20 etc.

## Test
curl -X POST "https://<your>.vercel.app/api/transcribe" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: <SUBTITLE_API_KEY>" \
  -d '{"file_url":"https://example.com/sample.mp4","output_format":"srt"}'


Donâ€™t:

å¸¸é§ã‚µãƒ¼ãƒï¼ˆapp.listenï¼‰ã‚’ç½®ã‹ãªã„

ffmpeg / /artifacts ä¿å­˜ / æ°¸ç¶šFS ã‚’å‰æã«ã—ãªã„

Notes:

GPTs å´ã® Actions èªè¨¼: ã€ŒAPIã‚­ãƒ¼ â†’ ã‚«ã‚¹ã‚¿ãƒ ã€/ ãƒ˜ãƒƒãƒ€ãƒ¼å X-API-Key / å€¤ã¯ SUBTITLE_API_KEY ã¨åŒä¸€ã€‚

é•·å°ºå¯¾å¿œãŒå¿…è¦ãªã‚‰ã€ã‚ã¨ã§éåŒæœŸã‚¸ãƒ§ãƒ–åŒ–ï¼ˆPOST /transcribe=job_idã€GET /jobs/{id}ï¼‰ã‚’è¿½åŠ ã™ã‚‹ã€‚